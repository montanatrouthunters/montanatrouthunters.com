name: "Generate and deploy"
# From https://swharden.com/blog/2022-03-20-github-actions-hugo/
on:
  workflow_dispatch:
  push:
env:
  LANG: "en_US.UTF-8"
  LANGUAGE: "en_US:en"
  LC_ALL: "en_US.UTF-8"
jobs:
  quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        hugo-version:
          - "latest"
          - "0.97.3"

    steps:
      - uses: actions/checkout@v3

      - name: Setup Hugo 💡
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ matrix.hugo-version }}
          extended: true

      - uses: actions/checkout@v3

      - name: Set up Ruby 2.6
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.6

      - name: Install dependencies
        run: gem install html-proofer

      - name: Proof HTML 📚
        run: |
          hugo --minify -v -b https://example.com/
          htmlproofer public --check-html --allow-hash-href --empty-alt-ignore --disable-external --ignore-empty-mailto

  deploy:
    name: Deploy to site.
    runs-on: ubuntu-latest
    needs:
      - quality
    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0
      - name: ✨ Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"
          extended: true
      - name: 🛠️ Build
        run: hugo --gc --minify -e production -b https://montanatrouthunters.com/
      - name: 📂 Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ftp.montanatrouthunters.com
          username: ${{ secrets.user }}
          password: ${{ secrets.password }}
          dry-run: false
          server-dir: ./public_html/
          local-dir: ./public/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.editorconfig*
            **/.hugo_build*
            **/go.*
            **/assets/**
            **/config/**
            **/content/**
            **/resources/**
            **/public/**